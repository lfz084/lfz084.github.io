<!DOCTYPE html>
<html>

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title></title>
    <link href="./style/main.css" rel="stylesheet" type="text/css">
    <link rel="preload" href="script/bindEvent.js" as="script">
    <link rel="preload" href="emoji/emoji.js" as="script">
    <link rel="preload" href="CheckerBoard/CheckerBoard.js" as="script">
    <link rel="preload" href="script/View.js" as="script">
    <link rel="preload" href="script/Button.js" as="script">
    <link rel="preload" href="IndexedDB/IndexedDB.js" as="script">
</head>

<body>
    <script src="script/bindEvent.js"></script>
    <script src="emoji/emoji.js"></script>
    <script src="CheckerBoard/CheckerBoard.js"></script>
    <script src="script/View.js"></script>
    <script src="script/Button.js"></script>
    <script src="IndexedDB/IndexedDB.js"></script>

    <script src="script/Button.js"></script>
    <script src="pdf/pdf.js"></script>
    <script>
        function $(id) { return document.getElementById(id) }

        let pdfDocument = null,
            pageIndex = 0;

        function readAsDataURL(file) {
            return new Promise(function(resolve) {
                try {
                    let fr = new FileReader();
                    fr.onload = function() {
                        resolve(fr.result)
                    };
                    fr.onerror = function() {
                        resolve("")
                    };
                    fr.readAsDataURL(file)
                } catch (e) {
                    alert(e.stack);
                    resolve("");
                }
            });
        }

        async function loadPage(doc, pageNum, canvas) {
            try {
                const page = await doc.getPage(pageNum);
                const viewport = page.getViewport({ scale: 1.5 });
                const ctx = canvas.getContext("2d");
                canvas.width = viewport.width;
                canvas.height = viewport.height;
                canvas.style.width = viewport.width + "px";
                canvas.style.height = viewport.height + "px";
                const renderContext = {
                    canvasContext: ctx,
                    viewport: viewport
                }
                await page.render(renderContext).promise;
                pageIndex = pageNum;
                return pageIndex;
            } catch (e) { alert(e.stack); return 0}
        }

        async function openPDF(file) {
            const url = await readAsDataURL(file);
            const doc = await pdfjsLib.getDocument(url).promise;
            URL.revokeObjectURL(url);
            pdfDocument = doc;
            pdfDocument && pdfDocument.numPages && await loadPage(pdfDocument, 1, cBoard.canvas);
        }

        async function nextPage() {
            if (pdfDocument && pageIndex < pdfDocument.numPages) {
                return  await loadPage(pdfDocument, ++pageIndex, cBoard.canvas)
            }
            else return 0
        }

        async function prePage() {
            if (pdfDocument && pageIndex > 1) {
                return await loadPage(pdfDocument, --pageIndex, cBoard.canvas)
            }
            else return 0;
        }

        document.body.onload = () => {
            try {
                window.d = document;
                window.dw = d.documentElement.clientWidth;
                window.dh = d.documentElement.clientHeight;
                window.cWidth = dw < dh ? dw * 0.95 : dh * 0.95; //棋盘宽度
                cWidth = dw < dh ? cWidth : dh < ~~(dw / 2 * 0.985) ? dh : ~~(dw / 2 * 0.985);

                window.cBoard = new CheckerBoard(document.body, 0, 0, cWidth, cWidth)
                cBoard.printEmptyCBoard();

                window.fileField = new Button(document.body, "file", 50, 50, 200, 80)
                fileField.setText("file");
                fileField.show();
                fileField.setonchange(function() {
                    openPDF(this.files[0])
                    setTimeout(() => this.value = "", 0)
                })
                fileField.input.accept = "application/zip";

                window.butNext = new Button(document.body, "button", 300, 50, 200, 80)
                butNext.setText("nextPage");
                butNext.show();
                butNext.setontouchend(function() {
                    nextPage()
                })

                window.butPre = new Button(document.body, "button", 550, 50, 200, 80)
                butPre.setText("prePage");
                butPre.show();
                butPre.setontouchend(function() {
                    prePage()
                })

            } catch (e) { alert(e.stack) }
        }
    </script>
</body>

</html>
