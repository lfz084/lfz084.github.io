<!DOCTYPE html>
<html>

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>makeVCF</title>
    <link href="./style/main.css" rel="stylesheet" type="text/css">
    <link rel="preload" href="script/bindEvent.js" as="script">
    <link rel="preload" href="emoji/emoji.js" as="script">
    <link rel="preload" href="CheckerBoard/CheckerBoard.js" as="script">
    <link rel="preload" href="TypeBuffer/TypeBuffer.js" as="script">
    <link rel="preload" href="script/View.js" as="script">
    <link rel="preload" href="script/Button.js" as="script">
    <link rel="preload" href="script/RenjuTree.js" as="script">
    <link rel="preload" href="makeVCF/makeVCF.js" as="script">
    <link rel="preload" href="eval/engine.js" as="script">
    <link rel="preload" href="IndexedDB/IndexedDB.js" as="script">
</head>

<body>
    <script src="script/bindEvent.js"></script>
    <script src="emoji/emoji.js"></script>
    <script src="CheckerBoard/CheckerBoard.js"></script>
    <script src="TypeBuffer/TypeBuffer.js"></script>
    <script src="script/View.js"></script>
    <script src="script/Button.js"></script>
    <script src="script/RenjuTree.js"></script>
    <script src="makeVCF/makeVCF.js"></script>
    <script src="eval/engine.js"></script>
    <script src="IndexedDB/IndexedDB.js"></script>

    <script>
        const STATE_STRING = {
            0: "已经完成搜索",
            1: "点击棋盘添加、删除",
            2: "等待搜索中",
            3: "正在搜索中",
            5: "暂停中...",
            6: "保存中..."
        }
        const STATE_DONE = 0,
            STATE_EMPTY = 1,
            STATE_WAITING = 2,
            STATE_SEARCHING = 3,
            STATE_STOPPING = 5,
            STATE_SAVING = 6;
        let oldState = 1;

        function $(id) { return document.getElementById(id) }

        function log(str) { $("log").innerText = str + "\n" + $("log").innerText.slice(0,500) }
        setInterval(() => {
            let info = makeVCF.getStateInfo();
            //log(`${STATE_STRING[info.state]}  进度${(info.progress*100).toFixed(2)}%   局面:${info.gameCount}  VCF: ${info.vcfGames.length}`)
            if (oldState != info.state) {
                miniBoard.cle();
                oldState = info.state;
            }
        }, 500)
    </script>
    <script>
        function createUI() {
            let bodyDiv = d.createElement("div");
            d.body.appendChild(bodyDiv);
            bodyDiv.style.position = "absolute";
            bodyDiv.style.width = "100%";
            bodyDiv.style.height = dw > dh ? "100%" : `${cWidth*2.1}px`;
            bodyDiv.style.left = "0px";
            bodyDiv.style.top = "0px";
            bodyDiv.style.opacity = "0";
            //bodyDiv.style.backgroundColor = "black";
            bodyDiv.setAttribute("class", "finish");
            bodyDiv.setAttribute("id", "bodyDiv");
            setTimeout(() => { bodyDiv.style.opacity = "1" }, 300);

            let upDiv = d.createElement("div");
            bodyDiv.appendChild(upDiv);
            upDiv.style.position = "absolute";
            upDiv.style.width = `${cWidth}px`;
            upDiv.style.height = `${cWidth}px`;
            upDiv.style.left = dw > dh ? ~~((dw - cWidth * 2) / 2) + "px" : (dw - cWidth) / 2 + "px";
            upDiv.style.top = dw > dh ? (dh - cWidth) / 2 + "px" : 0 + "px";
            //upDiv.style.backgroundColor = "green";
            upDiv.setAttribute("id", "upDiv");

            let downDiv = d.createElement("div");
            bodyDiv.appendChild(downDiv);
            downDiv.style.position = "absolute";
            downDiv.style.width = `${cWidth}px`;
            downDiv.style.height = `${cWidth}px`;
            downDiv.style.left = dw > dh ? ~~((dw - cWidth * 2) / 2) + cWidth + "px" : `${~~(dw-cWidth)/2}px`;
            downDiv.style.top = dw > dh ? parseInt(upDiv.style.top) + "px" : cWidth * 1.06 + "px";
            //downDiv.style.backgroundColor = "blue";
            downDiv.setAttribute("id", "downDiv")

            let logDiv = d.createElement("div");
            downDiv.appendChild(logDiv);
            logDiv.style.position = "absolute";
            logDiv.style.width = `${cWidth}px`;
            logDiv.style.height = `${cWidth}px`;
            logDiv.style.left = "0px";
            logDiv.style.top = "-50px";
            logDiv.style.fontSize = "30px";
            logDiv.style.textAlign = "center";
            //logDiv.style.backgroundColor = "pink";
            logDiv.setAttribute("id", "log")

            cBoard = new CheckerBoard(upDiv, 0, 0, cWidth, cWidth);
            cBoard.backgroundColor = "white";
            cBoard.resetCBoardCoordinate();
            cBoard.printEmptyCBoard();

            miniBoard = new CheckerBoard(downDiv, 0, 100, cWidth / 2, cWidth / 2);
            miniBoard.backgroundColor = "white";
            miniBoard.setCoordinate(0);
            miniBoard.resetCBoardCoordinate();
            miniBoard.printEmptyCBoard();


            let but1 = new Button($("downDiv"), "button", 10, 10, 150, 60);
            but1.setText("新建");
            but1.setontouchend(async function() {
                let boardArr = cBoard.getArray(),
                    stoneCount = boardArr.filter(v => v > 0).length,
                    blackStoneCount = stoneCount - (stoneCount >>> 1),
                    whiteStoneCount = stoneCount >>> 1;
                makeVCF.resetMakeVCF(boardArr, blackStoneCount, whiteStoneCount);
            })
            but1.show()

            let but2 = new Button($("downDiv"), "button", 190, 10, 150, 60);
            but2.setText("搜索");
            but2.setontouchend(async function() {
                makeVCF.continueMakeVCF()
            })
            but2.show()


            let but3 = new Button($("downDiv"), "button", 390, 10, 150, 60);
            but3.setText("暂停");
            but3.setontouchend(async function() {
                makeVCF.stop();
            })
            but3.show()

            let but4 = new Button($("downDiv"), "button", 580, 10, 150, 60);
            but4.setText("下一题");
            but4.setontouchend(async function() {
                miniBoard.unpackArray(makeVCF.nextVCF());
                miniBoard.resetNum = miniBoard.MSindex + 1;
            })
            but4.show()

            let but5 = new Button($("downDiv"), "button", 770, 10, 150, 60);
            but5.setText("上一题");
            but5.setontouchend(async function() {
                miniBoard.unpackArray(makeVCF.preVCF());
                miniBoard.resetNum = miniBoard.MSindex + 1;
            })
            but5.show()

            return bodyDiv;
        }

        function addEvents() {
            function ctnBack(idx) { // 触发快速悔棋
                if (idx + 1 && miniBoard.P[idx].type == TYPE_NUMBER) {
                    if (idx != miniBoard.MS[miniBoard.MSindex]) {
                        while (miniBoard.MS[miniBoard.MSindex] != idx) {
                            miniBoard.cleNb(miniBoard.MS[miniBoard.MSindex], true);
                        }
                    }
                }
            }
            bindEvent.setBodyDiv($("bodyDiv"))
            bindEvent.addEventListener(cBoard.viewBox, "click", (x, y) => {
                let idx = cBoard.getIndex(x, y);
                if (cBoard.P[idx].type == 0) cBoard.wNb(idx, "black")
                else cBoard.clePoint(idx)
            })
            bindEvent.addEventListener(cBoard.viewBox, "zoom", (x1, y1, x2, y2, scale) => {
                log(`zoom scale >>> ${scale}`)
                cBoard.scale *= scale;
                cBoard.scaleBox.style.transformOrigin = `0px 0px`;
                cBoard.scaleBox.style.transform = `scale(${cBoard.scale})`;
            })
            bindEvent.addEventListener(miniBoard.viewBox, "click", (x, y) => {
                let idx = miniBoard.getIndex(x, y);
                if (miniBoard.P[idx].type == 0) miniBoard.wNb(idx, "auto", true)
                else miniBoard.cleNb(idx, true)
            })
            bindEvent.addEventListener(miniBoard.viewBox, "dblclick", (x, y) => {
                let idx = miniBoard.getIndex(x, y);
                ctnBack(idx)
            })
        }

        window.cBoard = null;
        window.miniBoard = null;
        window.d = document;
        window.dw = d.documentElement.clientWidth;
        window.dh = d.documentElement.clientHeight;
        window.cWidth = dw < dh ? dw * 0.95 : dh * 0.95; //棋盘宽度
        window.cWidth = dw < dh ? cWidth : dh < ~~(dw / 2 * 0.985) ? dh : ~~(dw / 2 * 0.985);
        window.iphoneCancelClick = (() => {
            let isCancelClick = false;
            document.body.addEventListener("touchstart", () => { isCancelClick = false }, true);
            document.body.addEventListener("touchend", () => { setTimeout(() => { isCancelClick = false }, 250) }, true);
            return {
                enable: () => {
                    isCancelClick = !!(navigator.userAgent.indexOf("iPhone") + 1);
                },
                isCancel: () => {
                    setTimeout(() => { isCancelClick = false }, 100);
                    return isCancelClick;
                }
            }
        })();
    </script>
    <script>
        /*function click(x, y) { log(`canvas click x = ${x}, y = ${y}`) }

        function dblclick(x, y) { log(`canvas dblclick x = ${x}, y = ${y}`) }

        function contextmenu(x, y) {
            log(`canvas contextmenu x = ${x}, y = ${y}`);
            //bindEvent.movestart(x, y);
            iphoneCancelClick.enable();
            menu.showMenu(10, 10)
        }

        function movestart(x, y) { log(`canvas movestart x = ${x}, y = ${y}`) }

        function move(x, y) { log(`canvas move x = ${x}, y = ${y}`) }

        function moveend(x, y) { alert(`canvas moveend x = ${x}, y = ${y}`) }*/

        document.body.onload = () => {
            createUI();
            addEvents();
        }
    </script>
</body>

</html>
